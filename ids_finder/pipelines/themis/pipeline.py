# AUTOGENERATED! DO NOT EDIT! File to edit: ../../../notebooks/missions/themis/index.ipynb.

# %% auto 0
__all__ = ['filter_sw_events', 'create_sw_events_pipeline', 'create_pipeline']

# %% ../../../notebooks/missions/themis/index.ipynb 4
# | code-summary: import all the packages needed for the project
# | output: hide
import polars as pl
from kedro.pipeline import Pipeline, node
from kedro.pipeline.modular_pipeline import pipeline

from ... import PARAMS
from .mag import create_pipeline as create_mag_data_pipeline
from .state import create_pipeline as create_state_data_pipeline
from ..default.mission import create_combined_data_pipeline

from typing import Optional

# %% ../../../notebooks/missions/themis/index.ipynb 7
from ...utils.basic import filter_tranges_df

def filter_sw_events(events: pl.LazyFrame, sw_state: pl.LazyFrame) -> pl.LazyFrame:
    
    start, end = sw_state.select(['start', 'end']).collect()
    sw_events = filter_tranges_df(events.collect(), (start, end))
    
    return sw_events

def create_sw_events_pipeline(
    sat_id,
    tau: int = 60,
    ts_mag: int = 1,
    
):
  
    ts_mag_str = f"ts_{ts_mag}s"
    tau_str = f"tau_{tau}s"
    
    node_filter_sw_events = node(
        filter_sw_events,
        inputs=[
            f"events.{sat_id}_{ts_mag_str}_{tau_str}",
            f"{sat_id}.STATE.inter_data_sw",
        ],
        outputs=f"events.{sat_id}_sw_{ts_mag_str}_{tau_str}"
        
    )

    nodes = [node_filter_sw_events]
    return pipeline(nodes)

# %% ../../../notebooks/missions/themis/index.ipynb 9
def create_pipeline(
    sat_id="THB",
    params: Optional[dict] = None,
):
    
    if params is None:
        params = PARAMS
    tau = params["tau"]
    ts_state = params[sat_id]["STATE"]["time_resolution"]
    ts_mag = params[sat_id]["MAG"]["time_resolution"]
    ts_state_str = f"ts_{ts_state}s"


    input_combined_data = {
        f"{sat_id}.STATE.primary_data_{ts_state_str}": f"OMNI.LowRes.primary_data_{ts_state_str}"
    }
    
    node_combined_data = pipeline(
        create_combined_data_pipeline(sat_id),
        inputs=input_combined_data,
    )

    return (
        create_mag_data_pipeline(sat_id)
        + create_state_data_pipeline(sat_id)
        + node_combined_data
        + create_sw_events_pipeline(sat_id, tau=tau, ts_mag=ts_mag)
    )
